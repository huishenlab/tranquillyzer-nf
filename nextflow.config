// nextflow.config

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Shared parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

includeConfig 'conf/params.config'

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Execution profiles
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

profiles {

  // =========================
  // 1) Local + Docker (CPU)
  // =========================
  docker_local_cpu {
    process {
      executor  = 'local'
      container = params.container_trq
    }
    docker {
      enabled    = true
      // no GPUs requested here
      runOptions = ''
    }
  }

  // =========================
  // 2) Local + Docker (GPU)
  // =========================
  docker_local {
    process {
      executor  = 'local'
      container = params.container_trq

      // any process with `label 'gpu'` will see a GPU
      withLabel: 'gpu' {
        accelerator = 1
      }
    }
    docker {
      enabled    = true
      // expose all GPUs to the container
      runOptions = '--gpus all'
    }
  }

  // =========================
  // 3) Local + Singularity/Apptainer
  // =========================
  singularity_local {
    process {
      executor  = 'local'
      container = params.container_trq

      withLabel: 'gpu' {
        accelerator = 1
      }
    }
    singularity {
      enabled    = true
      autoMounts = true
      // required for GPU forwarding
      runOptions = '--nv'
    }
  }

  // =========================
  // 4) Slurm + Singularity/Apptainer
  // =========================
  slurm_singularity {
    process {
      executor  = 'slurm'
      queue     = 'shen'
      container = params.container_trq

      // GPU-aware processes
      withLabel: 'gpu' {
        accelerator = 4
      }
    }
    singularity {
      enabled    = true
      autoMounts = true
      runOptions = '--nv'
    }
  }
}


/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Output reports
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/


trace {
  enabled = true
  file    = "${params.outdir ?: 'results'}/pipeline_info/execution_trace.tsv"
  sep     = '\t'
  fields  = 'task_id,process,status,exit,submit,start,complete,realtime,%cpu,cpus,peak_rss,peak_vmem'
}

report {
  enabled = true
  file    = "${params.outdir ?: 'results'}/pipeline_info/execution_report.html"
}

timeline {
  enabled = true
  file    = "${params.outdir ?: 'results'}/pipeline_info/execution_timeline.html"
}

dag {
  enabled = true
  file    = "${params.outdir ?: 'results'}/pipeline_info/pipeline_dag.svg"
}