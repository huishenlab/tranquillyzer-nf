/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Shared parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

includeConfig 'conf/params.config'

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Execution profiles
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

profiles {

  // =========================
  // 1) Local + Docker (CPU)
  // =========================
  docker_local_cpu {

    process {
      executor  = 'local'
      container = params.container_trq

      // Use subread container only for featureCounts step
      withName: 'TRANQUILLYZER_PIPELINE:FEATURECOUNTS_MTX' {
        container = params.container_subread
      }

      // Ensure no GPU options for CPU profile
      containerOptions = ''
    }

    docker {
      enabled = true
    }
  }

  // =========================
  // 2) Local + Docker (GPU)
  // =========================
  docker_local {

    process {
      executor  = 'local'
      container = params.container_trq

      // Use subread container only for featureCounts step (no GPUs needed)
      withName: 'TRANQUILLYZER_PIPELINE:FEATURECOUNTS_MTX' {
        container        = params.container_subread
        containerOptions = ''
      }

      // GPU only for processes labeled 'gpu'
      withLabel: 'gpu' {
        accelerator      = 1
        containerOptions = '--gpus all'
      }

      // Explicitly ensure CPU-labeled processes don't get GPU options
      withLabel: 'cpu' {
        containerOptions = ''
      }
    }

    docker {
      enabled = true
    }
  }

  // =========================
  // 3) Local + Singularity/Apptainer
  // =========================
  singularity_local {

    process {
      executor  = 'local'
      container = params.container_trq

      // Use subread container only for featureCounts step
      withName: 'TRANQUILLYZER_PIPELINE:FEATURECOUNTS_MTX' {
        container        = params.container_subread
        containerOptions = ''   // important: don't add --nv here
      }

      // GPU only for processes labeled 'gpu'
      withLabel: 'gpu' {
        accelerator      = 1
        containerOptions = '--nv'
      }

      // CPU-labeled processes do not get --nv
      withLabel: 'cpu' {
        containerOptions = ''
      }
    }

    singularity {
      enabled    = true
      autoMounts = true
      cacheDir   = "$baseDir/.nf_singularity_cache"
    }
  }

  // =========================
  // 4) Slurm + Singularity
  // =========================
  singularity_slurm {

    process {
      executor  = 'slurm'
      queue     = 'shen'

      time     = '48h'
      cpus     = 64
      container = params.container_trq

      // Use subread container only for featureCounts step
      withName: 'TRANQUILLYZER_PIPELINE:FEATURECOUNTS_MTX' {
        container        = params.container_subread
        containerOptions = ''
      }

      // GPU-aware processes
      withLabel: 'gpu' {
        accelerator      = 4
        time             = '48h'
        containerOptions = '--nv'
      }

      // CPU-labeled processes do not get --nv
      withLabel: 'cpu' {
        time             = '48h'
        cpus             = 64
        containerOptions = ''
      }
    }

    singularity {
      enabled    = true
      autoMounts = true
      cacheDir   = "$baseDir/.nf_singularity_cache"
    }
  }
  // =========================
  // 5) Slurm + Apptainer
  // =========================
  apptainer_slurm {

    process {
      executor = 'slurm'
      queue    = 'shen'

      // sensible defaults (can be overridden per-label below)
      time  = '48h'
      cpus  = 64

      // default container for most steps
      container = params.container_trq

      /*
       * Load apptainer module + make CUDA libs visible inside container
       * (Do this here rather than inside your pipeline scripts.)
       */
      // beforeScript = '''
      //   source .bashrc || true
      //   module load bbc2/apptainer/apptainer-v1.4.3-1.el8

      //   export LD_LIBRARY_PATH=/cm/local/apps/cuda/libs/current/lib64:$LD_LIBRARY_PATH
      //   export APPTAINERENV_LD_LIBRARY_PATH=/cm/local/apps/cuda/libs/current/lib64
      // '''

      // --- process-specific container override ---
      withName: 'TRANQUILLYZER_PIPELINE:FEATURECOUNTS_MTX' {
        container        = params.container_subread
        containerOptions = ''          // no --nv for featureCounts
        time             = '48h'
      }

      // --- GPU processes ---
      withLabel: 'gpu' {
        cpus             = 64
        time             = '48h'

        containerOptions = '--nv'
      }

      // --- CPU processes ---
      withLabel: 'cpu' {
        cpus             = 64
        time             = '48h'

        containerOptions = ''
      }
    }

    apptainer {
      enabled   = true
      autoMounts = true

      // cache directory for images
      cacheDir  = "$baseDir/.nf_apptainer_cache"

      // If your cluster needs explicit binds, add them here.
      // bindPath = ['/varidata:/varidata', '/cm/local/apps/cuda/libs/current/lib64:/cm/local/apps/cuda/libs/current/lib64']
    }
  }
}

/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Output reports
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

trace {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/execution_trace.tsv"
  sep       = '\t'
  fields    = 'task_id,process,status,exit,submit,start,complete,realtime,%cpu,cpus,peak_rss,peak_vmem'
  overwrite = true
}

report {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/execution_report.html"
  overwrite = true
}

timeline {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/execution_timeline.html"
  overwrite = true
}

dag {
  enabled   = true
  file      = "${params.outdir}/pipeline_info/pipeline_dag.svg"
  overwrite = true
}