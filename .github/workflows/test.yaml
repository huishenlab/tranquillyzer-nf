name: run CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  nextflow-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        dataset: ["10x3p"]

    env:
      NF_TEST_CASE: ${{ matrix.dataset }}
      NF_TEST_OUTDIR: tests/${{ matrix.dataset }}/results

      # Cache dir for Singularity images (works reliably on GitHub runners)
      NXF_SINGULARITY_CACHEDIR: ${{ github.workspace }}/.singularity-cache

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java (Nextflow requires it)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Nextflow
        run: |
          set -euo pipefail
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/nextflow
          nextflow -version

      - name: Install SingularityCE (recommended on ubuntu-latest)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y singularity-container
          singularity --version

      - name: Debug - show test config and inputs
        run: |
          set -euo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -lah conf/tests || true
          ls -lah tests || true
          test -f "conf/tests/params_${NF_TEST_CASE}.config"
          test -f "tests/samplesheet.txt"
          test -f "tests/references/hg38_gencode_chr21.fa"
          test -f "tests/references/gencode.v30.annotation_chr21.gtf"

      - name: Cache Singularity image cache
        uses: actions/cache@v4
        with:
          path: .singularity-cache
          key: singularity-images-${{ runner.os }}-${{ matrix.dataset }}-v1

      - name: Run Nextflow (Singularity) for ${{ matrix.dataset }}
        run: |
          set -euo pipefail

          rm -rf "${NF_TEST_OUTDIR}"

          nextflow run . \
            -resume \
            -profile singularity \
            -c conf/tests/params_${NF_TEST_CASE}.config \
            --samplesheet tests/samplesheet.txt \
            --reference tests/references/hg38_gencode_chr21.fa \
            --gtf tests/references/gencode.v30.annotation_chr21.gtf \
            --outdir tests/10x3p \
            --enable_gpu false \
            --cleanup_transform true