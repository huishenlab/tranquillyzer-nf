name: run CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  nextflow-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        dataset: ["10x3p"]

    env:
      NF_TEST_CASE: ${{ matrix.dataset }}
      NF_TEST_OUTDIR: tests/${{ matrix.dataset }}/results

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java (Nextflow requires it)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Nextflow
        run: |
          set -euo pipefail
          curl -s https://get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/nextflow
          nextflow -version

      - name: Debug - show test config and inputs
        run: |
          set -euo pipefail
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -lah conf/tests || true
          ls -lah tests || true
          test -f "conf/tests/params_${NF_TEST_CASE}.config"
          test -f "tests/samplesheet.txt"
          test -f "tests/references/hg38_gencode_chr21.fa"
          test -f "tests/references/gencode.v30.annotation_chr21.gtf"

      # IMPORTANT: free runner disk (docker save tarballs are huge)
      - name: Free disk space
        run: |
          set -euo pipefail
          echo "== Before cleanup =="
          df -h

          # Remove large preinstalled toolchains we don't need
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android || true
          sudo apt-get clean || true

          # Clean docker junk (safe on fresh runners; helpful on cache hits too)
          docker system prune -af --volumes || true

          echo "== After cleanup =="
          df -h

      - name: Cache Docker images (compressed tar.gz)
        uses: actions/cache@v4
        with:
          path: .docker-cache
          key: docker-images-${{ runner.os }}-trq_v0.2.1_tf2.15.0-subread_2.0.6_py3.10.12-v1

      - name: Load cached images (if present)
        run: |
          set -euo pipefail
          mkdir -p .docker-cache
          if [ -f .docker-cache/trq.tar.gz ]; then
            echo "Loading cached tranquillyzer image..."
            gunzip -c .docker-cache/trq.tar.gz | docker load
          fi
          if [ -f .docker-cache/subread.tar.gz ]; then
            echo "Loading cached featurecounts image..."
            gunzip -c .docker-cache/subread.tar.gz | docker load
          fi

      - name: Pull images (if missing) and save compressed to cache
        run: |
          set -euo pipefail
          mkdir -p .docker-cache

          # Pull only if not already present (from cache load)
          docker image inspect varishenlab/tranquillyzer:tranquillyzer_v0.2.1_tf2.15.0 >/dev/null 2>&1 || \
            docker pull varishenlab/tranquillyzer:tranquillyzer_v0.2.1_tf2.15.0

          docker image inspect varishenlab/featurecounts:subread2.0.6_py3.10.12 >/dev/null 2>&1 || \
            docker pull varishenlab/featurecounts:subread2.0.6_py3.10.12

          echo "Disk before docker save:"
          df -h

          # Save compressed (much smaller; avoids 'no space left on device')
          docker save varishenlab/tranquillyzer:tranquillyzer_v0.2.1_tf2.15.0 | gzip -1 > .docker-cache/trq.tar.gz
          docker save varishenlab/featurecounts:subread2.0.6_py3.10.12 | gzip -1 > .docker-cache/subread.tar.gz

          echo "Cache contents:"
          ls -lah .docker-cache

          echo "Disk after docker save:"
          df -h

      - name: Run Nextflow (local CPU) for ${{ matrix.dataset }}
        run: |
          set -euo pipefail

          rm -rf "${NF_TEST_OUTDIR}"

          nextflow run . \
            -resume \
            -profile docker \
            -c conf/tests/params_${NF_TEST_CASE}.config \
            --samplesheet tests/samplesheet.txt \
            --reference tests/references/hg38_gencode_chr21.fa \
            --gtf tests/references/gencode.v30.annotation_chr21.gtf \
            --outdir tests/10x3p \
            --enable_gpu false \
            --cleanup_transform true