name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  nextflow:
    name: Nextflow (${{ matrix.dataset }})
    runs-on: ubuntu-latest
    timeout-minutes: 90

    strategy:
      fail-fast: false
      matrix:
        dataset: ["10x3p"]  # add later: "10x5p", "tranquil_seq"

    env:
      NXF_VER: "24.10.4"
      NXF_ANSI_LOG: "false"
      NXF_OPTS: "-Xms1g -Xmx4g"
      NF_TEST_CASE: ${{ matrix.dataset }}

      # Keep outdir under workspace so artifacts can be uploaded reliably
      NF_OUTDIR: ${{ github.workspace }}/tests/${{ matrix.dataset }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Nextflow
        uses: nf-core/setup-nextflow@v1
        with:
          version: ${{ env.NXF_VER }}

      - name: Show versions
        run: |
          nextflow -version
          docker --version

      - name: Cache Nextflow + workDir
        uses: actions/cache@v4
        with:
          path: |
            ~/.nextflow
            ${{ github.workspace }}/.nf-work
          key: nf-${{ runner.os }}-${{ env.NXF_VER }}-${{ matrix.dataset }}-${{ hashFiles('**/*.nf', 'nextflow.config', 'conf/**/*.config') }}
          restore-keys: |
            nf-${{ runner.os }}-${{ env.NXF_VER }}-${{ matrix.dataset }}-
            nf-${{ runner.os }}-${{ env.NXF_VER }}-

      - name: Run pipeline (docker, CPU, test dataset)
        run: |
          set -euo pipefail

          # Use runner temp at runtime (not in expressions)
          export NXF_HOME="${RUNNER_TEMP}/nf-home"
          export NXF_WORK="${RUNNER_TEMP}/nf-work/${NF_TEST_CASE}"

          mkdir -p "${NXF_HOME}" "${NXF_WORK}"
          rm -rf "${NF_OUTDIR}"

          # Also keep a workspace work dir for caching (optional)
          mkdir -p "${GITHUB_WORKSPACE}/.nf-work"

          nextflow run . \
            -profile docker \
            -work-dir "${NXF_WORK}" \
            --outdir "${NF_OUTDIR}" \
            -resume \
            -with-report "${NF_OUTDIR}/pipeline_info/execution_report.html" \
            -with-timeline "${NF_OUTDIR}/pipeline_info/execution_timeline.html" \
            -with-trace "${NF_OUTDIR}/pipeline_info/execution_trace.tsv" \
            -with-dag "${NF_OUTDIR}/pipeline_info/pipeline_dag.svg"

      - name: Sanity checks (ETL outputs exist)
        run: |
          set -euo pipefail

          test -d "${NF_OUTDIR}/extract"
          test -d "${NF_OUTDIR}/transform"
          test -d "${NF_OUTDIR}/load"
          test -d "${NF_OUTDIR}/pipeline_info"

          # At least one sample folder should exist under load
          test "$(find "${NF_OUTDIR}/load" -mindepth 1 -maxdepth 1 -type d | wc -l)" -ge 1

          # BAM exists somewhere in load/*/bam
          test "$(find "${NF_OUTDIR}/load" -type f -name 'demuxed_aligned_dup_marked.bam' | wc -l)" -ge 1

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nf-${{ matrix.dataset }}-artifacts
          path: |
            ${{ env.NF_OUTDIR }}/pipeline_info/**
            ${{ env.NF_OUTDIR }}/logs/**
            .nextflow.log
          if-no-files-found: warn