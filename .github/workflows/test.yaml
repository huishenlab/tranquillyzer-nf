env:
  NXF_SINGULARITY_CACHEDIR: ${{ github.workspace }}/.singularity-cache

steps:
  - uses: actions/checkout@v4

  - name: Set up Java
    uses: actions/setup-java@v4
    with:
      distribution: temurin
      java-version: "17"

  - name: Install Nextflow
    run: |
      set -euo pipefail
      curl -s https://get.nextflow.io | bash
      sudo mv nextflow /usr/local/bin/nextflow
      nextflow -version

  - name: Install SingularityCE
    run: |
      set -euo pipefail
      sudo apt-get update
      sudo apt-get install -y singularity-container
      singularity --version

  - name: Cache Singularity images
    uses: actions/cache@v4
    with:
      path: .singularity-cache
      key: singularity-images-${{ runner.os }}-v1

  - name: Run Nextflow (singularity) for ${{ matrix.dataset }}
    run: |
      set -euo pipefail
      nextflow run . \
        -resume \
        -profile singularity \
        -c conf/tests/params_${NF_TEST_CASE}.config \
        --samplesheet tests/samplesheet.txt \
        --reference tests/references/hg38_gencode_chr21.fa \
        --gtf tests/references/gencode.v30.annotation_chr21.gtf \
        --outdir tests/10x3p \
        --enable_gpu false \
        --cleanup_transform true